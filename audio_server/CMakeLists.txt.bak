cmake_minimum_required(VERSION 3.18)
project(AudioServer VERSION 0.1.0 LANGUAGES C CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# ---------------------------------------------------------------------------
# Build options
# ---------------------------------------------------------------------------
option(ENABLE_LV2    "Build with LV2 plugin hosting (requires lilv)"  ON)
option(ENABLE_SF2    "Build with SF2/FluidSynth support"              ON)
option(ENABLE_TESTS  "Build test programs"                            ON)

# ---------------------------------------------------------------------------
# Platform detection
# ---------------------------------------------------------------------------
if(WIN32 OR MINGW OR CMAKE_SYSTEM_NAME STREQUAL "Windows")
    set(PLATFORM_WINDOWS TRUE)
    add_compile_definitions(AS_PLATFORM_WINDOWS)
    # When cross-compiling from Linux with MinGW, CMAKE_SYSTEM_NAME is "Windows"
    # but we may be running on Linux. The toolchain file handles the rest.
else()
    set(PLATFORM_LINUX TRUE)
    add_compile_definitions(AS_PLATFORM_LINUX)
endif()

# ---------------------------------------------------------------------------
# Find dependencies
# ---------------------------------------------------------------------------

# PortAudio — audio I/O (MIT licensed)
# Cross-compilation: point PKG_CONFIG_PATH to mingw sysroot
find_package(PkgConfig REQUIRED)

pkg_check_modules(PORTAUDIO REQUIRED portaudio-2.0)

# nlohmann/json — header-only
# Prefer a pre-downloaded copy in include/nlohmann/json.hpp (e.g. from
# `sudo apt install nlohmann-json3-dev`).  Fall back to FetchContent.
find_path(NLOHMANN_JSON_INCLUDE_DIR nlohmann/json.hpp
    HINTS ${CMAKE_CURRENT_SOURCE_DIR}/include /usr/include /usr/local/include)

if(NLOHMANN_JSON_INCLUDE_DIR)
    message(STATUS "nlohmann/json found at: ${NLOHMANN_JSON_INCLUDE_DIR}")
else()
    message(STATUS "nlohmann/json not found locally — using FetchContent")
    include(FetchContent)
    FetchContent_Declare(nlohmann_json
        URL https://github.com/nlohmann/json/releases/download/v3.11.3/json.hpp
        DOWNLOAD_NO_EXTRACT TRUE
        DOWNLOAD_DIR ${CMAKE_CURRENT_SOURCE_DIR}/include/nlohmann
    )
    FetchContent_MakeAvailable(nlohmann_json)
    set(NLOHMANN_JSON_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/include)
endif()

if(ENABLE_LV2)
    pkg_check_modules(LILV REQUIRED lilv-0)
    pkg_check_modules(LV2 REQUIRED lv2)
    add_compile_definitions(AS_ENABLE_LV2)
endif()

if(ENABLE_SF2)
    pkg_check_modules(FLUIDSYNTH REQUIRED fluidsynth)
    add_compile_definitions(AS_ENABLE_SF2)
endif()

# ---------------------------------------------------------------------------
# Main server library (shared between server binary and tests)
# ---------------------------------------------------------------------------
add_library(audio_server_lib STATIC
    src/graph.cpp
    src/ipc.cpp
    src/scheduler.cpp
    src/synth_node.cpp
    src/audio_engine.cpp
)

target_include_directories(audio_server_lib PUBLIC
    include/
    ${NLOHMANN_JSON_INCLUDE_DIR}
    ${PORTAUDIO_INCLUDE_DIRS}
)

target_link_libraries(audio_server_lib PUBLIC
    ${PORTAUDIO_LIBRARIES}
)

target_compile_options(audio_server_lib PRIVATE
    ${PORTAUDIO_CFLAGS_OTHER}
)

if(ENABLE_LV2)
    target_include_directories(audio_server_lib PUBLIC ${LILV_INCLUDE_DIRS} ${LV2_INCLUDE_DIRS})
    target_link_libraries(audio_server_lib PUBLIC ${LILV_LIBRARIES})
    target_sources(audio_server_lib PRIVATE src/lv2_host.cpp)
endif()

if(ENABLE_SF2)
    target_include_directories(audio_server_lib PUBLIC ${FLUIDSYNTH_INCLUDE_DIRS})
    target_link_libraries(audio_server_lib PUBLIC ${FLUIDSYNTH_LIBRARIES})
endif()

# Windows: link winsock for IPC sockets
if(PLATFORM_WINDOWS)
    target_link_libraries(audio_server_lib PUBLIC ws2_32)
endif()

# ---------------------------------------------------------------------------
# Server executable
# ---------------------------------------------------------------------------
add_executable(audio_server src/main.cpp)
target_link_libraries(audio_server PRIVATE audio_server_lib)

# ---------------------------------------------------------------------------
# Tests
# ---------------------------------------------------------------------------
if(ENABLE_TESTS)
    add_executable(test_ipc test/test_ipc.cpp)
    target_link_libraries(test_ipc PRIVATE audio_server_lib)

    add_executable(test_graph test/test_graph.cpp)
    target_link_libraries(test_graph PRIVATE audio_server_lib)

    add_executable(test_render test/test_render.cpp)
    target_link_libraries(test_render PRIVATE audio_server_lib)
endif()

# ---------------------------------------------------------------------------
# Install
# ---------------------------------------------------------------------------
install(TARGETS audio_server DESTINATION bin)
