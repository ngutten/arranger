<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>Music Arranger</title>
<style>
:root{--bg:#1a1a2e;--bg2:#16213e;--bg3:#0f3460;--accent:#e94560;--accent2:#533483;--text:#eee;--text2:#aaa;--grid:#2a2a4a}
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Segoe UI',system-ui,sans-serif;background:var(--bg);color:var(--text);overflow:hidden;height:100vh}
.app{display:flex;flex-direction:column;height:100vh}
.topbar{display:flex;align-items:center;gap:10px;padding:6px 12px;background:var(--bg2);border-bottom:1px solid var(--grid);flex-shrink:0;flex-wrap:wrap}
.topbar h1{font-size:15px;color:var(--accent);margin-right:12px}
.topbar label{font-size:11px;color:var(--text2)}
.topbar input,.topbar select,.topbar button{background:var(--bg);color:var(--text);border:1px solid var(--grid);padding:3px 7px;border-radius:3px;font-size:11px}
.topbar button{cursor:pointer}.topbar button:hover{background:var(--accent)}
.sp{flex:1;min-width:8px}
.play-btn{font-size:14px!important;padding:3px 10px!important}.play-btn.on{background:var(--accent)!important;color:#fff}
.loop-btn.on{background:var(--accent2)!important;color:#fff}
.main{display:flex;flex:1;overflow:hidden}
/* Left panel */
.pl{width:220px;min-width:180px;background:var(--bg2);border-right:1px solid var(--grid);display:flex;flex-direction:column;flex-shrink:0}
.ph{padding:6px 10px;font-size:12px;font-weight:600;border-bottom:1px solid var(--grid);display:flex;align-items:center;justify-content:space-between}
.ph button{background:var(--accent);color:#fff;border:none;padding:2px 7px;border-radius:3px;cursor:pointer;font-size:10px}
.plist{flex:1;overflow-y:auto;padding:4px}
.pi{padding:5px 8px;margin:2px 0;border-radius:3px;cursor:pointer;font-size:11px;display:flex;align-items:center;border:1px solid transparent}
.pi:hover{background:var(--bg3)}.pi.sel{border-color:var(--accent);background:rgba(233,69,96,.12)}
.pi .cd{width:9px;height:9px;border-radius:50%;margin-right:7px;flex-shrink:0}
.pi .nm{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.pi .ac{display:flex;gap:3px}
.pi .ac button{background:none;border:none;color:var(--text2);cursor:pointer;font-size:10px;padding:1px 3px}
.pi .ac button:hover{color:var(--accent)}
.pki{padding:6px 10px;font-size:11px;border-top:1px solid var(--grid);color:var(--text2)}
/* Center */
.center{flex:1;display:flex;flex-direction:column;overflow:hidden}
.aa{flex:1;display:flex;flex-direction:column;overflow:hidden}
.ah{height:28px;background:var(--bg2);border-bottom:1px solid var(--grid);overflow:hidden;flex-shrink:0;padding-left:150px}
.ab{display:flex;flex:1;overflow:hidden}
.tl{width:150px;flex-shrink:0;background:var(--bg2);border-right:1px solid var(--grid);overflow-y:auto}
.tli{height:56px;padding:4px 8px;border-bottom:1px solid var(--grid);font-size:10px;display:flex;flex-direction:column;justify-content:center;cursor:pointer}
.tli:hover{background:var(--bg3)}.tli.sel{background:rgba(233,69,96,.08);border-left:3px solid var(--accent)}
.tli .tn{font-weight:600;font-size:11px}.tli .ti{color:var(--text2);font-size:9px;margin-top:1px}
.aw{flex:1;overflow:auto}
#arrC{display:block}
/* Piano roll */
.pa{height:280px;min-height:120px;border-top:2px solid var(--accent);display:flex;flex-direction:column;flex-shrink:0}
.pah{height:26px;background:var(--bg2);display:flex;align-items:center;padding:0 8px;border-bottom:1px solid var(--grid);font-size:11px;gap:6px;flex-shrink:0}
.pab{display:flex;flex:1;overflow:hidden}
.pk{width:44px;flex-shrink:0;background:var(--bg2);overflow-y:auto;border-right:1px solid var(--grid)}
.pkk{height:14px;font-size:7px;line-height:14px;padding:0 3px;text-align:right;color:var(--text2);border-bottom:1px solid #1a1a2e}
.pkk.bk{background:#111;color:#555}.pkk.cn{border-bottom:1px solid var(--accent2);font-weight:bold;color:var(--text)}
.pkk.ik{background:rgba(83,52,131,.18)}
.pw{flex:1;overflow:auto}
#prC{display:block}
/* Right panel */
.rp{width:250px;min-width:200px;background:var(--bg2);border-left:1px solid var(--grid);display:flex;flex-direction:column;flex-shrink:0;overflow-y:auto}
.ss{padding:8px 10px;border-bottom:1px solid var(--grid)}
.ss h3{font-size:11px;color:var(--accent);margin-bottom:6px}
.sr{display:flex;align-items:center;gap:6px;margin-bottom:5px;font-size:11px}
.sr label{width:55px;color:var(--text2);flex-shrink:0;font-size:10px}
.sr input,.sr select{flex:1;background:var(--bg);color:var(--text);border:1px solid var(--grid);padding:2px 5px;border-radius:3px;font-size:10px}
.sr input[type=number]{width:55px;flex:none}
.prl{max-height:180px;overflow-y:auto;border:1px solid var(--grid);border-radius:3px;margin-top:3px}
.pri{padding:2px 6px;font-size:10px;cursor:pointer}
.pri:hover{background:var(--bg3)}.pri.on{background:rgba(233,69,96,.15);color:var(--accent)}
/* Modal */
.mo{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,.55);z-index:1000;align-items:center;justify-content:center}
.mo.show{display:flex}
.md{background:var(--bg2);border:1px solid var(--grid);border-radius:6px;padding:16px;min-width:280px;max-width:460px}
.md h2{font-size:14px;margin-bottom:10px;color:var(--accent)}
.md input[type=text],.md select{width:100%;background:var(--bg);color:var(--text);border:1px solid var(--grid);padding:5px 8px;border-radius:3px;margin-bottom:8px;font-size:12px}
.md .br{display:flex;gap:6px;justify-content:flex-end;margin-top:10px}
.btn{padding:5px 14px;border:none;border-radius:3px;cursor:pointer;font-size:11px}
.btn-p{background:var(--accent);color:#fff}.btn-s{background:var(--grid);color:var(--text)}.btn:hover{opacity:.85}
.rh{height:4px;background:var(--accent);cursor:ns-resize;flex-shrink:0}.rh:hover{background:#ff6b8a}
.tbb{display:flex;gap:2px;padding:0 3px;border-left:1px solid var(--grid);margin-left:3px}
.tb{background:var(--bg);color:var(--text);border:1px solid var(--grid);padding:2px 7px;border-radius:3px;cursor:pointer;font-size:10px}
.tb.on{background:var(--accent);border-color:var(--accent)}.tb:hover{border-color:var(--accent)}
::-webkit-scrollbar{width:7px;height:7px}::-webkit-scrollbar-track{background:var(--bg)}::-webkit-scrollbar-thumb{background:var(--grid);border-radius:3px}
.vl{height:50px;border-top:1px solid var(--grid);flex-shrink:0;overflow:hidden}
#velC{display:block}
/* Beat kit */
.bki{border:1px solid var(--grid);border-radius:3px;margin:4px 0;padding:6px;font-size:10px}
.bki:hover{background:var(--bg3)}
.bki.exp{background:rgba(233,69,96,.05);border-color:var(--accent)}
.bki-h{display:flex;align-items:center;gap:6px}
.bki-h .cd{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.bki-h .nm{flex:1;font-weight:600}
.bki-h button{background:none;border:none;color:var(--text2);cursor:pointer;padding:1px 4px;font-size:9px}
.bki-h button:hover{color:var(--accent)}
.bki-e{margin-top:6px;padding-top:6px;border-top:1px solid var(--grid);display:none}
.bki.exp .bki-e{display:block}
.bki-r{display:flex;align-items:center;gap:4px;margin-bottom:4px}
.bki-r label{width:42px;color:var(--text2);font-size:9px}
.bki-r input,.bki-r select{flex:1;background:var(--bg);color:var(--text);border:1px solid var(--grid);padding:2px 4px;border-radius:2px;font-size:9px}
.bki-r input[type=number]{width:45px;flex:none}
.bki-r input[type=range]{width:70px}
.bki-r button{padding:2px 6px;background:var(--bg);border:1px solid var(--grid);border-radius:2px;cursor:pointer;font-size:9px}
.bki-r button:hover{border-color:var(--accent)}
/* Beat grid */
.bgl{width:70px;flex-shrink:0;background:var(--bg2);overflow-y:auto;border-right:1px solid var(--grid)}
.bgl-i{height:28px;font-size:9px;padding:0 6px;border-bottom:1px solid var(--grid);display:flex;align-items:center;cursor:pointer}
.bgl-i:hover{background:var(--bg3)}
.bgl-i .cd{width:8px;height:8px;border-radius:50%;margin-right:5px;flex-shrink:0}
.bgl-i .nm{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.bgw{flex:1;overflow:auto}
#bgC{display:block}
</style>
</head><body>
<div class="app">
<!-- Topbar -->
<div class="topbar">
  <h1>‚ô™ Arranger</h1>
  <button class="play-btn" id="playBtn" onclick="togglePlay()" title="Space">‚ñ∂</button>
  <button class="play-btn loop-btn" id="loopBtn" onclick="toggleLoop()" title="Loop">üîÅ</button>
  <label>BPM</label><input type="number" id="bpmIn" value="120" min="20" max="300" style="width:60px" onchange="S.bpm=+this.value">
  <label>TS</label>
  <select id="tsNum" onchange="S.tsNum=+this.value;renderAll()" style="width:48px"><option value="2">2</option><option value="3">3</option><option value="4" selected>4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option></select>
  /<select id="tsDen" onchange="S.tsDen=+this.value;renderAll()" style="width:48px"><option value="2">2</option><option value="4" selected>4</option><option value="8">8</option></select>
  <label>Snap</label>
  <select id="snapSel" onchange="S.snap=+this.value"><option value="1">1</option><option value="0.5" selected>1/2</option><option value="0.25">1/4</option><option value="0.125">1/8</option><option value="0.0625">1/16</option></select>
  <div class="sp"></div>
  <button onclick="loadSF2()">Load SF2</button><button onclick="addTrack()">+ Track</button><button onclick="addBeatTrack()">+ Beat Track</button>
  <span style="color:var(--grid)">|</span>
  <button onclick="doExport('midi')">MIDI</button><button onclick="doExport('wav')">WAV</button><button onclick="doExport('mp3')">MP3</button>
  <button onclick="saveProj()">Save</button><button onclick="loadProj()">Load</button>
</div>
<div class="main">
<!-- Left -->
<div class="pl">
  <div class="ph">Patterns <button onclick="createPat()">+ New</button></div>
  <div class="plist" id="patList"></div>
  <div class="pki" id="patKeyInfo"></div>
  <div style="height:1px;background:var(--grid);margin:8px 0"></div>
  <div class="ph">Beat Patterns <button onclick="createBeatPat()">+ New</button></div>
  <div class="plist" id="beatPatList"></div>
</div>
<!-- Center -->
<div class="center">
  <div class="aa"><div class="ah"><canvas id="tlC"></canvas></div>
    <div class="ab"><div class="tl" id="trkLabels"></div><div class="aw" id="arrWrap"><canvas id="arrC"></canvas></div></div>
  </div>
  <div class="rh" id="resizeH"></div>
  <div class="pa" id="prArea">
    <div class="pah">
      <span id="prName">No pattern</span>
      <button class="tb" onclick="previewPattern()" id="prevBtn" title="Preview this pattern" style="margin-left:8px;padding:2px 8px">‚ñ∂ Preview</button>
      <div class="sp"></div>
      <label style="font-size:10px;color:var(--text2)">Len</label>
      <select id="noteLenSel" style="width:70px;padding:1px 4px;font-size:10px" onchange="S.noteLen=this.value">
        <option value="snap">Snap</option>
        <option value="last">Last</option>
        <option value="0.0625">1/16</option>
        <option value="0.125">1/8</option>
        <option value="0.25" selected>1/4</option>
        <option value="0.5">1/2</option>
        <option value="1">1</option>
        <option value="2">2</option>
        <option value="4">4</option>
      </select>
      <div class="tbb" style="margin-left:6px">
        <button class="tb on" onclick="setTool('draw',this)">‚úè Draw</button>
        <button class="tb" onclick="setTool('select',this)">‚óª Sel</button>
        <button class="tb" onclick="setTool('erase',this)">‚úï Del</button>
      </div>
      <label style="font-size:10px;color:var(--text2);margin-left:6px">Vel</label>
      <input type="range" id="velSlider" min="1" max="127" value="100" style="width:50px">
      <span id="velVal" style="font-size:10px;width:20px">100</span>
    </div>
    <!-- Piano roll (for melodic patterns) -->
    <div class="pab" id="prContent">
      <div class="pk" id="pianoKeys"></div>
      <div style="flex:1;display:flex;flex-direction:column;overflow:hidden">
        <div class="pw" id="prWrap"><canvas id="prC"></canvas></div>
        <div class="vl"><canvas id="velC"></canvas></div>
      </div>
    </div>
    <!-- Beat grid (for beat patterns) -->
    <div class="pab" id="bgContent" style="display:none">
      <div class="bgl" id="beatLanes"></div>
      <div class="bgw" id="bgWrap"><canvas id="bgC"></canvas></div>
    </div>
  </div>
</div>
<!-- Right -->
<div class="rp">
  <div class="ss"><h3>Track Settings</h3><div id="trkSet"><p style="color:var(--text2);font-size:11px">Select a track</p></div></div>
  <div class="ss"><h3>Soundfont</h3><div id="sf2Inf"><p style="color:var(--text2);font-size:11px">No soundfont</p></div></div>
  <div class="ss"><h3>Placement</h3><div id="plSet"><p style="color:var(--text2);font-size:11px">Click a placement</p></div></div>
  <div class="ss"><h3 style="display:flex;align-items:center;justify-content:space-between">Beat Kit<button onclick="addBeatInst()" style="background:var(--accent);color:#fff;border:none;padding:2px 7px;border-radius:3px;cursor:pointer;font-size:10px">+</button></h3><div id="beatKit"></div></div>
</div>
</div></div>

<!-- Modals -->
<div class="mo" id="sf2Modal"><div class="md"><h2>Load SoundFont</h2>
<p style="font-size:11px;color:var(--text2);margin-bottom:8px">Select .sf2 file from instruments/ directory:</p>
<select id="sf2Select" style="width:100%;background:var(--bg);color:var(--text);border:1px solid var(--grid);padding:5px 8px;border-radius:3px;margin-bottom:8px;font-size:12px">
  <option value="">Loading...</option>
</select>
<p style="font-size:10px;color:var(--text2);margin-top:4px">Place .sf2 files in the instruments/ directory</p>
<div class="br"><button class="btn btn-s" onclick="$('sf2Modal').classList.remove('show')">Cancel</button>
<button class="btn btn-p" onclick="submitSF2()">Load</button></div></div></div>

<div class="mo" id="patModal"><div class="md"><h2 id="pmT">New Pattern</h2>
<input type="text" id="pmName" placeholder="Name">
<div class="sr"><label>Length</label><input type="number" id="pmLen" value="4" min="1" max="128"> <span style="font-size:10px;color:var(--text2)">beats</span></div>
<div class="sr"><label>Base Key</label>
  <select id="pmKey"><option>C</option><option>C#</option><option>D</option><option>D#</option><option>E</option><option>F</option><option>F#</option><option>G</option><option>G#</option><option>A</option><option>A#</option><option>B</option></select>
  <select id="pmScale"><option value="major">Major</option><option value="minor">Minor</option><option value="dorian">Dorian</option><option value="mixolydian">Mixolydian</option><option value="phrygian">Phrygian</option><option value="lydian">Lydian</option><option value="pentatonic">Pentatonic</option><option value="blues">Blues</option><option value="chromatic">Chromatic</option></select>
</div>
<div class="sr"><label>Preview</label>
  <select id="pmPreview"><option value="sf2">Soundfont</option><option value="sine">Clean Tone</option></select>
</div>
<div class="br"><button class="btn btn-s" onclick="$('patModal').classList.remove('show')">Cancel</button>
<button class="btn btn-p" onclick="submitPat()">OK</button></div></div></div>

<div class="mo" id="beatPatModal"><div class="md"><h2 id="bpmT">New Beat Pattern</h2>
<input type="text" id="bpmName" placeholder="Name">
<div class="sr"><label>Length</label><input type="number" id="bpmLen" value="4" min="1" max="128"> <span style="font-size:10px;color:var(--text2)">beats</span></div>
<div class="sr"><label>Subdivision</label>
  <select id="bpmSubdiv">
    <option value="2">8th notes (2/beat)</option>
    <option value="3">Triplets (3/beat)</option>
    <option value="4" selected>16th notes (4/beat)</option>
    <option value="6">16th triplets (6/beat)</option>
  </select>
</div>
<div class="br"><button class="btn btn-s" onclick="$('beatPatModal').classList.remove('show')">Cancel</button>
<button class="btn btn-p" onclick="submitBeatPat()">OK</button></div></div></div>

<input type="file" id="projIn" accept=".json" style="display:none" onchange="handleProjLoad(event)">
<audio id="audioEl"></audio>

<script>
const $=id=>document.getElementById(id);
const NN=['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
const PC=['#e94560','#533483','#0f3460','#00b4d8','#06d6a0','#ffd166','#ef476f','#118ab2','#9b5de5','#f15bb5','#00f5d4','#fee440'];
const GM=["Acoustic Grand Piano","Bright Acoustic Piano","Electric Grand Piano","Honky-tonk Piano","Electric Piano 1","Electric Piano 2","Harpsichord","Clavinet","Celesta","Glockenspiel","Music Box","Vibraphone","Marimba","Xylophone","Tubular Bells","Dulcimer","Drawbar Organ","Percussive Organ","Rock Organ","Church Organ","Reed Organ","Accordion","Harmonica","Tango Accordion","Acoustic Guitar (nylon)","Acoustic Guitar (steel)","Electric Guitar (jazz)","Electric Guitar (clean)","Electric Guitar (muted)","Overdriven Guitar","Distortion Guitar","Guitar Harmonics","Acoustic Bass","Electric Bass (finger)","Electric Bass (pick)","Fretless Bass","Slap Bass 1","Slap Bass 2","Synth Bass 1","Synth Bass 2","Violin","Viola","Cello","Contrabass","Tremolo Strings","Pizzicato Strings","Orchestral Harp","Timpani","String Ensemble 1","String Ensemble 2","Synth Strings 1","Synth Strings 2","Choir Aahs","Voice Oohs","Synth Choir","Orchestra Hit","Trumpet","Trombone","Tuba","Muted Trumpet","French Horn","Brass Section","Synth Brass 1","Synth Brass 2","Soprano Sax","Alto Sax","Tenor Sax","Baritone Sax","Oboe","English Horn","Bassoon","Clarinet","Piccolo","Flute","Recorder","Pan Flute","Blown Bottle","Shakuhachi","Whistle","Ocarina","Lead 1 (square)","Lead 2 (sawtooth)","Lead 3 (calliope)","Lead 4 (chiff)","Lead 5 (charang)","Lead 6 (voice)","Lead 7 (fifths)","Lead 8 (bass+lead)","Pad 1 (new age)","Pad 2 (warm)","Pad 3 (polysynth)","Pad 4 (choir)","Pad 5 (bowed)","Pad 6 (metallic)","Pad 7 (halo)","Pad 8 (sweep)","FX 1 (rain)","FX 2 (soundtrack)","FX 3 (crystal)","FX 4 (atmosphere)","FX 5 (brightness)","FX 6 (goblins)","FX 7 (echoes)","FX 8 (sci-fi)","Sitar","Banjo","Shamisen","Koto","Kalimba","Bagpipe","Fiddle","Shanai","Tinkle Bell","Agogo","Steel Drums","Woodblock","Taiko Drum","Melodic Tom","Synth Drum","Reverse Cymbal","Guitar Fret Noise","Breath Noise","Seashore","Bird Tweet","Telephone Ring","Helicopter","Applause","Gunshot"];
const SCALES={major:[0,2,4,5,7,9,11],minor:[0,2,3,5,7,8,10],dorian:[0,2,3,5,7,9,10],mixolydian:[0,2,4,5,7,9,10],phrygian:[0,1,3,5,7,8,10],lydian:[0,2,4,6,7,9,11],pentatonic:[0,2,4,7,9],blues:[0,3,5,6,7,10],chromatic:[0,1,2,3,4,5,6,7,8,9,10,11]};

function notePC(n){return NN.indexOf(n)}
function scaleSet(root,sc){const r=notePC(root),iv=SCALES[sc]||SCALES.major;return new Set(iv.map(i=>(r+i)%12))}
function keyShift(from,to){return((notePC(to)-notePC(from))%12+12)%12}

// ========== State ==========
let S={bpm:120,snap:0.5,tsNum:4,tsDen:4,patterns:[],tracks:[],placements:[],
  selPat:null,selTrk:null,selPl:null,sf2:null,prTool:'draw',clipboard:[],nextId:1,
  playing:false,looping:false,playhead:undefined,noteLen:'0.25',lastNoteLen:0.25,defVel:100,
  // Beat track additions
  beatKit:[],beatPatterns:[],beatTracks:[],beatPlacements:[],
  selBeatPat:null,selBeatTrk:null,selBeatPl:null};
let prSel=new Set();
function gid(){return S.nextId++}

// ========== Note Preview ==========
let audioCtx=null;
let sf2SampleCache={}; // {bank_program: {buffer, refPitch}}
function getAudioCtx(){if(!audioCtx)audioCtx=new(window.AudioContext||window.webkitAudioContext)();return audioCtx}

async function loadSF2Sample(bank,program){
  const key=`${bank}_${program}`;
  if(sf2SampleCache[key])return sf2SampleCache[key];
  if(!S.sf2?.path)return null;
  try{
    const r=await fetch('/api/render_sample',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({sf2_path:S.sf2.path,bank,program,pitch:60,velocity:100})});
    if(!r.ok)return null;
    const arrayBuf=await r.arrayBuffer();
    const ctx=getAudioCtx();
    const audioBuf=await ctx.decodeAudioData(arrayBuf);
    sf2SampleCache[key]={buffer:audioBuf,refPitch:60};
    return sf2SampleCache[key];
  }catch(e){console.warn('SF2 sample load failed:',e);return null}
}

function playNote(pitch,velocity=100,duration=0.15){
  const pat=S.patterns.find(x=>x.id===S.selPat);
  const mode=pat?.previewMode||'sine';
  if(mode==='sf2'){playNoteSF2(pitch,velocity);return}
  playSine(pitch,velocity,duration);
}

async function playNoteSF2(pitch,velocity=100,bank,program){
  // If bank/program not provided, fall back to selected track
  if(bank===undefined||program===undefined){
    const t=S.tracks.find(x=>x.id===S.selTrk);
    if(!t){playSine(pitch,velocity);return}
    bank=t.bank||0;
    program=t.program||0;
  }
  const sample=await loadSF2Sample(bank,program);
  if(!sample){playSine(pitch,velocity);return} // fallback
  try{
    const ctx=getAudioCtx(),now=ctx.currentTime;
    const src=ctx.createBufferSource(),gain=ctx.createGain();
    src.buffer=sample.buffer;
    src.playbackRate.value=Math.pow(2,(pitch-sample.refPitch)/12);
    gain.gain.setValueAtTime((velocity/127)*0.3,now);
    src.connect(gain);gain.connect(ctx.destination);
    src.start(now);
  }catch(e){console.warn('SF2 preview failed:',e);playSine(pitch,velocity)}
}

function playSine(pitch,velocity=100,duration=0.15){
  try{
    const ctx=getAudioCtx(),now=ctx.currentTime,freq=440*Math.pow(2,(pitch-69)/12);
    const osc=ctx.createOscillator(),gain=ctx.createGain();
    osc.type='sine';osc.frequency.value=freq;
    const vol=(velocity/127)*0.2;
    gain.gain.setValueAtTime(0,now);
    gain.gain.linearRampToValueAtTime(vol,now+0.01);
    gain.gain.exponentialRampToValueAtTime(0.001,now+duration);
    osc.connect(gain);gain.connect(ctx.destination);
    osc.start(now);osc.stop(now+duration);
  }catch(e){console.warn('Audio preview failed:',e)}
}

// ========== Patterns ==========
function createPat(){$('pmT').textContent='New Pattern';$('pmName').value='Pattern '+(S.patterns.length+1);
  $('pmLen').value=S.tsNum;$('pmKey').value='C';$('pmScale').value='major';$('pmPreview').value='sf2';
  $('patModal').classList.add('show');$('patModal').dataset.m='c';$('pmName').focus()}
function submitPat(){const m=$('patModal').dataset.m,nm=$('pmName').value||'Pattern',
  len=Math.max(1,+$('pmLen').value||4),k=$('pmKey').value,sc=$('pmScale').value,pv=$('pmPreview').value||'sf2';
  if(m==='c'){const p={id:gid(),name:nm,length:len,notes:[],color:PC[S.patterns.length%PC.length],key:k,scale:sc,previewMode:pv};
    S.patterns.push(p);S.selPat=p.id}else{const p=S.patterns.find(x=>x.id===S.selPat);
    if(p){p.name=nm;p.length=len;p.key=k;p.scale=sc;p.previewMode=pv}}
  $('patModal').classList.remove('show');renderAll()}
function selectPat(id){S.selPat=id;S.selBeatPat=null;prSel.clear();rPatList();rBeatPatList();rPR();rVL();rPKI()}
function renamePat(id){const p=S.patterns.find(x=>x.id===id);if(!p)return;S.selPat=id;
  $('pmT').textContent='Edit Pattern';$('pmName').value=p.name;$('pmLen').value=p.length;
  $('pmKey').value=p.key||'C';$('pmScale').value=p.scale||'major';$('pmPreview').value=p.previewMode||'sf2';
  $('patModal').classList.add('show');$('patModal').dataset.m='e'}
function delPat(id){S.patterns=S.patterns.filter(x=>x.id!==id);S.placements=S.placements.filter(x=>x.patternId!==id);
  if(S.selPat===id)S.selPat=null;renderAll()}
function dupPat(id){const p=S.patterns.find(x=>x.id===id);if(!p)return;
  const n={...JSON.parse(JSON.stringify(p)),id:gid(),name:p.name+' copy',color:PC[S.patterns.length%PC.length]};
  S.patterns.push(n);S.selPat=n.id;renderAll()}
function rPatList(){const c=$('patList');c.innerHTML='';S.patterns.forEach(p=>{const d=document.createElement('div');
  d.className='pi'+(S.selPat===p.id?' sel':'');
  d.innerHTML=`<span class="cd" style="background:${p.color}"></span><span class="nm">${p.name} <span style="color:var(--text2);font-size:9px">${p.length}b ${p.key||'C'} ${(p.scale||'major').slice(0,3)}</span></span><span class="ac"><button title="Dup" onclick="event.stopPropagation();dupPat(${p.id})">‚ßâ</button><button title="Edit" onclick="event.stopPropagation();renamePat(${p.id})">‚úé</button><button title="Del" onclick="event.stopPropagation();delPat(${p.id})">‚úï</button></span>`;
  d.onclick=()=>selectPat(p.id);d.draggable=true;
  d.ondragstart=e=>e.dataTransfer.setData('text/plain',JSON.stringify({type:'pattern',pid:p.id}));
  c.appendChild(d)})}
function rPKI(){const c=$('patKeyInfo'),p=S.patterns.find(x=>x.id===S.selPat);
  c.innerHTML=p?`Key: <b>${p.key||'C'} ${p.scale||'major'}</b>`:''}

// ========== Tracks ==========
function addTrack(){const t={id:gid(),name:'Track '+(S.tracks.length+1),channel:S.tracks.length%16,bank:0,program:0,volume:100};
  S.tracks.push(t);if(!S.selTrk)S.selTrk=t.id;rTL();rTS();rArr()}
function selTrack(id){S.selTrk=id;S.selBeatTrk=null;rTL();rTS()}
function delTrk(id){S.tracks=S.tracks.filter(x=>x.id!==id);S.placements=S.placements.filter(x=>x.trackId!==id);
  if(S.selTrk===id)S.selTrk=S.tracks[0]?.id||null;renderAll()}

// Beat Track Management
function addBeatTrack(){const bt={id:gid(),name:'Beat '+(S.beatTracks.length+1)};
  S.beatTracks.push(bt);if(!S.selBeatTrk)S.selBeatTrk=bt.id;rTL();rBeatTS();rArr()}
function selBeatTrack(id){S.selBeatTrk=id;S.selTrk=null;rTL();rBeatTS()}
function delBeatTrk(id){S.beatTracks=S.beatTracks.filter(x=>x.id!==id);S.beatPlacements=S.beatPlacements.filter(x=>x.trackId!==id);
  if(S.selBeatTrk===id)S.selBeatTrk=S.beatTracks[0]?.id||null;renderAll()}
function rBeatTS(){const c=$('trkSet'),bt=S.beatTracks.find(x=>x.id===S.selBeatTrk);
  if(!bt){return}  // Let melodic track settings show if no beat track selected
  c.innerHTML=`<div class="sr"><label>Name</label><input type="text" value="${bt.name}" onchange="uBeatTrk('name',this.value)"></div>
<div class="sr"><label>Type</label><span style="font-size:10px;color:var(--accent)">Beat Track</span></div>
<div class="sr"><label></label><button class="btn btn-s" style="font-size:10px" onclick="delBeatTrk(${bt.id})">Delete Track</button></div>`}
function uBeatTrk(k,v){const bt=S.beatTracks.find(x=>x.id===S.selBeatTrk);if(bt){bt[k]=v;rTL()}}

function pName(b,p){if(S.sf2?.presets){const x=S.sf2.presets.find(z=>z.bank===b&&z.program===p);if(x)return x.name}return GM[p]||`B${b}/P${p}`}
function rTL(){const c=$('trkLabels');c.innerHTML='';
  // Melodic tracks
  S.tracks.forEach(t=>{const d=document.createElement('div');
    d.className='tli'+(S.selTrk===t.id?' sel':'');
    d.innerHTML=`<div class="tn">${t.name} <span style="color:var(--text2);font-size:9px">ch${t.channel+1}</span></div><div class="ti">${pName(t.bank,t.program)}</div>`;
    d.onclick=()=>selTrack(t.id);d.oncontextmenu=e=>{e.preventDefault();if(confirm('Delete "'+t.name+'"?'))delTrk(t.id)};
    c.appendChild(d)});
  // Beat tracks
  S.beatTracks.forEach(bt=>{const d=document.createElement('div');
    d.className='tli'+(S.selBeatTrk===bt.id?' sel':'');
    d.innerHTML=`<div class="tn">‚ô™ ${bt.name}</div><div class="ti" style="color:var(--accent)">Beat Track</div>`;
    d.onclick=()=>selBeatTrack(bt.id);d.oncontextmenu=e=>{e.preventDefault();if(confirm('Delete "'+bt.name+'"?'))delBeatTrk(bt.id)};
    c.appendChild(d)})}
function rTS(){const c=$('trkSet'),t=S.tracks.find(x=>x.id===S.selTrk);
  if(!t){c.innerHTML='<p style="color:var(--text2);font-size:11px">Select a track</p>';rPL();return}
  c.innerHTML=`<div class="sr"><label>Name</label><input type="text" value="${t.name}" onchange="uTrk('name',this.value)"></div>
<div class="sr"><label>Channel</label><select onchange="uTrk('channel',+this.value)">${Array.from({length:16},(_,i)=>`<option value="${i}" ${t.channel===i?'selected':''}>Ch ${i+1}${i===9?' (Drums)':''}</option>`).join('')}</select></div>
<div class="sr"><label>Bank</label><input type="number" value="${t.bank}" min="0" max="16383" onchange="uTrk('bank',+this.value)"></div>
<div class="sr"><label>Program</label><input type="number" value="${t.program}" min="0" max="127" onchange="uTrk('program',+this.value)"></div>
<div class="sr"><label>Preset</label><span style="font-size:10px;color:var(--accent)">${pName(t.bank,t.program)}</span></div>
<div class="sr"><label>Volume</label><input type="range" min="0" max="127" value="${t.volume||100}" oninput="uTrk('volume',+this.value)" style="flex:1"><span style="font-size:9px;width:22px">${t.volume||100}</span></div>
<div class="sr"><label></label><button class="btn btn-s" style="font-size:10px" onclick="delTrk(${t.id})">Delete Track</button></div>`;rPL()}
function uTrk(k,v){const t=S.tracks.find(x=>x.id===S.selTrk);if(t){t[k]=v;rTL();if(k==='bank'||k==='program')rPL()}}
function rPL(){const c=$('sf2Inf'),t=S.tracks.find(x=>x.id===S.selTrk);
  if(!S.sf2){c.innerHTML='<p style="color:var(--text2);font-size:11px">No soundfont loaded</p>';return}
  const bks=[...new Set(S.sf2.presets.map(p=>p.bank))].sort((a,b)=>a-b),sb=t?t.bank:0,
    fp=S.sf2.presets.filter(p=>p.bank===sb);
  c.innerHTML=`<p style="font-size:10px;color:var(--text2);margin-bottom:4px">${S.sf2.name}</p>
<div class="sr"><label>Bank</label><select onchange="fBank(+this.value)" style="font-size:10px">${bks.map(b=>`<option value="${b}" ${b===sb?'selected':''}>Bank ${b}</option>`).join('')}</select></div>
<div class="prl">${fp.map(p=>`<div class="pri ${t&&t.bank===p.bank&&t.program===p.program?'on':''}" onclick="sPre(${p.bank},${p.program})">${p.program}: ${p.name}</div>`).join('')}</div>`}
function fBank(b){const t=S.tracks.find(x=>x.id===S.selTrk);if(t)t.bank=b;rPL();rTL()}
function sPre(b,p){const t=S.tracks.find(x=>x.id===S.selTrk);if(t){t.bank=b;t.program=p}rTS();rTL()}
async function loadSF2(){
  $('sf2Modal').classList.add('show');
  const sel=$('sf2Select');
  sel.innerHTML='<option value="">Loading...</option>';
  try{
    const r=await fetch('/api/list_sf2');
    const d=await r.json();
    if(d.files.length===0){
      sel.innerHTML='<option value="">No .sf2 files found</option>';
    }else{
      sel.innerHTML='<option value="">-- Select a soundfont --</option>'+
        d.files.map(f=>`<option value="${f.name}">${f.displayName} (${f.name})</option>`).join('');
    }
  }catch(e){
    sel.innerHTML='<option value="">Error loading files</option>';
  }
}
async function submitSF2(){
  const filename=$('sf2Select').value;
  if(!filename)return;
  try{
    const r=await fetch('/api/load_sf2',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({filename})});
    const d=await r.json();
    if(d.error){alert(d.error);return}
    S.sf2=d;
    $('sf2Modal').classList.remove('show');
    rPL();rTL();
  }catch(e){alert(e.message)}
}

async function autoLoadFirstSF2(){
  try{
    const r=await fetch('/api/list_sf2');
    const d=await r.json();
    if(d.files.length>0){
      const filename=d.files[0].name;
      const r2=await fetch('/api/load_sf2',{method:'POST',headers:{'Content-Type':'application/json'},
        body:JSON.stringify({filename})});
      const d2=await r2.json();
      if(!d2.error){
        S.sf2=d2;
        rPL();rTL();
        console.log('Auto-loaded soundfont:',filename);
      }
    }
  }catch(e){console.warn('Could not auto-load soundfont:',e)}
}

// ========== Piano Roll ==========
const P={nH:14,bW:80,lo:24,hi:96};
function setTool(t,btn){S.prTool=t;document.querySelectorAll('.pah .tb').forEach(b=>b.classList.remove('on'));if(btn)btn.classList.add('on')}
function buildKeys(){const c=$('pianoKeys');c.innerHTML='';
  const pat=S.patterns.find(x=>x.id===S.selPat),ik=pat?scaleSet(pat.key||'C',pat.scale||'major'):new Set();
  for(let p=P.hi;p>=P.lo;p--){const nm=NN[p%12],oct=Math.floor(p/12)-1,isB=nm.includes('#'),isC=p%12===0;
    const d=document.createElement('div');
    d.className='pkk'+(isB?' bk':'')+(isC?' cn':'')+(ik.has(p%12)?' ik':'');
    d.textContent=isC?`C${oct}`:(isB?'':nm+oct);d.style.height=P.nH+'px';
    d.style.cursor='pointer';d.onclick=(()=>{const pitch=p;return()=>playNote(pitch,100)})();
    c.appendChild(d)}}

function velColor(v){const t=v/127;if(t<.33){const u=t/.33;return`rgb(${60|0},${60+u*160|0},${200-u*60|0})`}
  if(t<.66){const u=(t-.33)/.33;return`rgb(${60+u*180|0},${220-u*40|0},${140-u*100|0})`}
  const u=(t-.66)/.34;return`rgb(240,${180-u*120|0},${40-u*40|0})`}

function rPR(){
  // If beat pattern selected, show beat grid instead
  if(S.selBeatPat){
    rBG();
    return;
  }
  
  const pat=S.patterns.find(x=>x.id===S.selPat);
  $('prName').textContent=pat?`‚úé ${pat.name} (${pat.length}b, ${pat.key||'C'} ${pat.scale||'major'})`:'No pattern';
  
  // Show piano roll content
  $('prContent').style.display='flex';
  $('bgContent').style.display='none';
  
  buildKeys();
  const cv=$('prC'),w=$('prWrap'),pR=P.hi-P.lo+1,tH=pR*P.nH,tW=pat?pat.length*P.bW:16*P.bW;
  cv.width=Math.max(tW,w.clientWidth);cv.height=Math.max(tH,w.clientHeight-2);
  const c=cv.getContext('2d');c.clearRect(0,0,cv.width,cv.height);
  const ik=pat?scaleSet(pat.key||'C',pat.scale||'major'):new Set();
  const bpm=S.tsNum*(4/S.tsDen);
  // Grid rows
  for(let p=P.lo;p<=P.hi;p++){const y=(P.hi-p)*P.nH,isB=NN[p%12].includes('#'),isC=p%12===0,ink=ik.has(p%12);
    c.fillStyle=isB?(ink?'#1a1530':'#15152a'):(ink?'#1e1a35':'#1a1a30');
    c.fillRect(0,y,cv.width,P.nH);c.strokeStyle=isC?'#3a3a6a':'#222244';c.lineWidth=isC?1:.5;
    c.beginPath();c.moveTo(0,y);c.lineTo(cv.width,y);c.stroke()}
  // Beat lines
  const beats=pat?pat.length:16;
  for(let b=0;b<=beats*4;b++){const x=b*P.bW/4,bn=b/4,
    isM=Math.abs(bn%bpm)<.001||Math.abs(bn%bpm-bpm)<.001,isB2=b%4===0;
    c.strokeStyle=isM?'#4a4a8a':isB2?'#3a3a6a':b%2===0?'#2a2a5a':'#222244';
    c.lineWidth=isM?1.5:isB2?1:.5;c.beginPath();c.moveTo(x,0);c.lineTo(x,cv.height);c.stroke()}
  if(!pat)return;
  // Notes
  pat.notes.forEach((n,i)=>{const x=n.start*P.bW,y=(P.hi-n.pitch)*P.nH,w2=n.duration*P.bW,sel=prSel.has(i);
    c.fillStyle=velColor(n.velocity||100);c.globalAlpha=sel?1:.75;
    c.fillRect(x,y+1,w2-1,P.nH-2);c.globalAlpha=1;
    c.strokeStyle=sel?'#fff':pat.color;c.lineWidth=sel?2:1;c.strokeRect(x,y+1,w2-1,P.nH-2);
    c.fillStyle='#fff3';c.fillRect(x+w2-4,y+1,3,P.nH-2);
    if(sel){c.fillStyle='#fff';c.font='8px sans-serif';c.fillText('v'+(n.velocity||100),x+2,y+P.nH-3)}})}

function rVL(){const pat=S.patterns.find(x=>x.id===S.selPat),cv=$('velC'),w=$('prWrap');
  const tW=pat?pat.length*P.bW:16*P.bW;cv.width=Math.max(tW,w.clientWidth);cv.height=50;
  const c=cv.getContext('2d');c.fillStyle='#12121f';c.fillRect(0,0,cv.width,cv.height);
  c.strokeStyle='#2a2a4a';c.lineWidth=.5;c.beginPath();c.moveTo(0,25);c.lineTo(cv.width,25);c.stroke();
  if(!pat)return;const bw=Math.max(3,S.snap*P.bW*.6);
  pat.notes.forEach((n,i)=>{const x=n.start*P.bW+2,v=n.velocity||100,h=v/127*46;
    c.fillStyle=prSel.has(i)?'#fff':velColor(v);c.fillRect(x,48-h,bw,h)})}

function initPR(){const cv=$('prC');let dn=null,doff={x:0},rn=null;
  function pos(e){const r=cv.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top}}
  function sn(b){return Math.floor(b/S.snap)*S.snap}
  function hit(x,y){const pat=S.patterns.find(p=>p.id===S.selPat);if(!pat)return null;
    const pitch=P.hi-Math.floor(y/P.nH),beat=x/P.bW;
    for(let i=pat.notes.length-1;i>=0;i--){const n=pat.notes[i];
      if(n.pitch===pitch&&beat>=n.start&&beat<n.start+n.duration)return{n,i,res:beat>n.start+n.duration-.15}}return null}
  cv.addEventListener('mousedown',e=>{const pat=S.patterns.find(p=>p.id===S.selPat);if(!pat)return;
    const{x,y}=pos(e),pitch=P.hi-Math.floor(y/P.nH),beat=x/P.bW;
    // Right click - delete note
    if(e.button===2){e.preventDefault();const h=hit(x,y);if(h){pat.notes.splice(h.i,1);prSel.delete(h.i);rPR();rVL();rArr()}return}
    if(S.prTool==='draw'){const h=hit(x,y);
      if(h?.res){rn=h.n}else if(h){dn=h.n;doff={x:beat-h.n.start}}
      else{const v=+$('velSlider').value||100;
        // Calculate note length based on dropdown
        let dur=S.snap;
        if(S.noteLen==='snap')dur=S.snap;
        else if(S.noteLen==='last')dur=S.lastNoteLen;
        else dur=parseFloat(S.noteLen);
        const nn={pitch,start:sn(beat),duration:dur,velocity:v};
        pat.notes.push(nn);rn=nn;S.lastNoteLen=dur;playNote(pitch,v);rPR();rVL()}}
    else if(S.prTool==='erase'){const h=hit(x,y);if(h){pat.notes.splice(h.i,1);prSel.delete(h.i);rPR();rVL();rArr()}}
    else if(S.prTool==='select'){const h=hit(x,y);if(h){if(!e.shiftKey)prSel.clear();
      if(prSel.has(h.i))prSel.delete(h.i);else prSel.add(h.i);
      if(h.res)rn=h.n;else{dn=h.n;doff={x:beat-h.n.start}}}else prSel.clear();rPR();rVL()}});
  cv.addEventListener('mousemove',e=>{const{x,y}=pos(e),pitch=P.hi-Math.floor(y/P.nH),beat=x/P.bW;
    if(rn){rn.duration=Math.max(S.snap,sn(beat-rn.start));rPR();rVL()}
    else if(dn){dn.start=Math.max(0,sn(beat-doff.x));dn.pitch=pitch;rPR();rVL()}});
  const up=()=>{
    if(rn){S.lastNoteLen=rn.duration;rPR();rVL();rArr()}
    else if(dn){rPR();rVL();rArr()}
    dn=null;rn=null};
  cv.addEventListener('mouseup',up);cv.addEventListener('mouseleave',up);
  cv.addEventListener('contextmenu',e=>e.preventDefault());
  // Scroll sync (bidirectional)
  let scrolling=false;
  $('prWrap').addEventListener('scroll',()=>{if(scrolling)return;scrolling=true;
    $('pianoKeys').scrollTop=$('prWrap').scrollTop;
    $('velC').style.transform=`translateX(${-$('prWrap').scrollLeft}px)`;
    requestAnimationFrame(()=>scrolling=false)});
  $('pianoKeys').addEventListener('scroll',()=>{if(scrolling)return;scrolling=true;
    $('prWrap').scrollTop=$('pianoKeys').scrollTop;
    requestAnimationFrame(()=>scrolling=false)});
  // Velocity lane dragging
  const vc=$('velC');let vd=false;
  function setV(e){const pat=S.patterns.find(p=>p.id===S.selPat);if(!pat)return;
    const r=vc.getBoundingClientRect(),x=e.clientX-r.left+$('prWrap').scrollLeft,y=e.clientY-r.top;
    const vel=Math.max(1,Math.min(127,Math.round((1-y/48)*127))),beat=x/P.bW;
    let best=-1,bd=Infinity;pat.notes.forEach((n,i)=>{const d=Math.abs(beat-n.start);if(d<bd&&d<.5){bd=d;best=i}});
    if(best>=0){pat.notes[best].velocity=vel;rPR();rVL()}}
  vc.addEventListener('mousedown',e=>{vd=true;setV(e)});
  vc.addEventListener('mousemove',e=>{if(vd)setV(e)});
  vc.addEventListener('mouseup',()=>vd=false);vc.addEventListener('mouseleave',()=>vd=false);
  $('velSlider').addEventListener('input',function(){$('velVal').textContent=this.value})}

// ========== Keyboard shortcuts ==========
document.addEventListener('keydown',e=>{
  if(e.code==='Space'&&!['INPUT','SELECT','TEXTAREA'].includes(e.target.tagName)){e.preventDefault();togglePlay();return}
  const pat=S.patterns.find(p=>p.id===S.selPat);if(!pat)return;
  if(e.ctrlKey||e.metaKey){
    if(e.key==='c'){S.clipboard=[];prSel.forEach(i=>{if(pat.notes[i])S.clipboard.push({...pat.notes[i]})});
      if(!S.clipboard.length)S.clipboard=pat.notes.map(n=>({...n}))}
    else if(e.key==='v'&&S.clipboard.length){const mx=pat.notes.length?Math.max(...pat.notes.map(n=>n.start+n.duration)):0;
      const cm=Math.min(...S.clipboard.map(n=>n.start)),off=mx-cm;prSel.clear();
      S.clipboard.forEach(n=>{pat.notes.push({...n,start:n.start+off});prSel.add(pat.notes.length-1)});
      const ne=Math.max(...pat.notes.map(n=>n.start+n.duration));if(ne>pat.length)pat.length=Math.ceil(ne);renderAll()}
    else if(e.key==='a'){e.preventDefault();prSel.clear();pat.notes.forEach((_,i)=>prSel.add(i));rPR();rVL()}}
  if((e.key==='Delete'||e.key==='Backspace')&&prSel.size&&S.prTool==='select'){
    const keep=pat.notes.filter((_,i)=>!prSel.has(i));pat.notes.length=0;pat.notes.push(...keep);prSel.clear();rPR();rVL();rArr()}});

// ========== Arrangement ==========
const A={tH:56,bW:30,tot:64};
function rArr(){const cv=$('arrC'),w=$('arrWrap'),tl=$('tlC');
  const totalTracks=S.tracks.length+S.beatTracks.length;
  const tW=A.tot*A.bW,tH=Math.max(totalTracks*A.tH,w.clientHeight||200);
  cv.width=Math.max(tW,w.clientWidth||600);cv.height=tH;
  const bpm=S.tsNum*(4/S.tsDen);
  // Timeline
  tl.width=cv.width;tl.height=28;const tc=tl.getContext('2d');
  tc.fillStyle='#16213e';tc.fillRect(0,0,tl.width,28);let mn=1;
  for(let b=0;b<=A.tot;b++){const x=b*A.bW,isM=Math.abs(b%bpm)<.001||b===0;
    if(isM&&b<A.tot){tc.fillStyle='#aaa';tc.font='10px sans-serif';tc.fillText(`${mn}`,x+3,11);mn++;
      tc.strokeStyle='#4a4a8a';tc.lineWidth=1}else{tc.strokeStyle='#222244';tc.lineWidth=.5}
    tc.beginPath();tc.moveTo(x,14);tc.lineTo(x,28);tc.stroke()}
  w.onscroll=()=>{tl.style.transform=`translateX(${-w.scrollLeft}px)`;$('trkLabels').scrollTop=w.scrollTop};
  const c=cv.getContext('2d');c.clearRect(0,0,cv.width,cv.height);
  
  // Draw all track backgrounds (melodic + beat)
  for(let i=0;i<totalTracks;i++){
    const y=i*A.tH;c.fillStyle=i%2?'#181828':'#1a1a30';c.fillRect(0,y,cv.width,A.tH);
    c.strokeStyle='#222244';c.lineWidth=.5;c.beginPath();c.moveTo(0,y+A.tH);c.lineTo(cv.width,y+A.tH);c.stroke();
  }
  
  for(let b=0;b<=A.tot;b++){const x=b*A.bW,isM=Math.abs(b%bpm)<.001||b===0;
    c.strokeStyle=isM?'#3a3a7a':'#1e1e3a';c.lineWidth=isM?1:.5;c.beginPath();c.moveTo(x,0);c.lineTo(x,cv.height);c.stroke()}
  
  // Melodic Placements
  S.placements.forEach(pl=>{const ti=S.tracks.findIndex(t=>t.id===pl.trackId),pat=S.patterns.find(p=>p.id===pl.patternId);
    if(ti<0||!pat)return;const y=ti*A.tH,x=pl.time*A.bW,tl2=pat.length*(pl.repeats||1),w2=tl2*A.bW,sel=S.selPl===pl.id;
    c.fillStyle=pat.color+(sel?'cc':'88');c.fillRect(x,y+2,w2-1,A.tH-4);
    if(sel){c.strokeStyle='#fff';c.lineWidth=2;c.strokeRect(x,y+2,w2-1,A.tH-4)}
    for(let r=1;r<(pl.repeats||1);r++){const rx=x+r*pat.length*A.bW;c.strokeStyle='#fff3';c.lineWidth=1;
      c.setLineDash([3,3]);c.beginPath();c.moveTo(rx,y+4);c.lineTo(rx,y+A.tH-4);c.stroke();c.setLineDash([])}
    if(pat.notes.length){const ps=pat.notes.map(n=>n.pitch),mn2=Math.min(...ps),mx2=Math.max(...ps),rg=Math.max(1,mx2-mn2);
      pat.notes.forEach(n=>{const ny=y+A.tH-6-((n.pitch-mn2)/rg)*(A.tH-12),nx=x+n.start/pat.length*pat.length*A.bW,
        nw=Math.max(2,n.duration/pat.length*pat.length*A.bW);c.fillStyle='#fff5';c.fillRect(nx+2,ny,nw-1,2)})}
    let lb=pat.name;const ts=computeT(pl);if(ts)lb+=` (${ts>0?'+':''}${ts})`;
    if(pl.targetKey&&pl.targetKey!==(pat.key||'C'))lb+=` ‚Üí ${pl.targetKey}`;
    c.fillStyle='#fff';c.font='10px sans-serif';c.fillText(lb,x+4,y+13);
    c.fillStyle='#fff4';c.fillRect(x+w2-5,y+2,4,A.tH-4)});
  
  // Beat Placements
  S.beatPlacements.forEach(bp=>{const ti=S.beatTracks.findIndex(t=>t.id===bp.trackId);
    if(ti<0)return;
    const pat=S.beatPatterns.find(p=>p.id===bp.patternId);
    if(!pat)return;
    const y=(S.tracks.length+ti)*A.tH,x=bp.time*A.bW,tl2=pat.length*(bp.repeats||1),w2=tl2*A.bW,sel=S.selBeatPl===bp.id;
    c.fillStyle=pat.color+(sel?'cc':'88');c.fillRect(x,y+2,w2-1,A.tH-4);
    if(sel){c.strokeStyle='#fff';c.lineWidth=2;c.strokeRect(x,y+2,w2-1,A.tH-4)}
    for(let r=1;r<(bp.repeats||1);r++){const rx=x+r*pat.length*A.bW;c.strokeStyle='#fff3';c.lineWidth=1;
      c.setLineDash([3,3]);c.beginPath();c.moveTo(rx,y+4);c.lineTo(rx,y+A.tH-4);c.stroke();c.setLineDash([])}
    // Visual indicator for beat patterns (small dots for instruments)
    const activeInsts=Object.entries(pat.grid||{}).filter(([_,g])=>g.some(v=>v>0)).slice(0,3);
    activeInsts.forEach(([instId],idx)=>{
      c.fillStyle='#fff8';c.beginPath();c.arc(x+8+idx*6,y+A.tH-8,2,0,Math.PI*2);c.fill();
    });
    c.fillStyle='#fff';c.font='10px sans-serif';c.fillText(pat.name,x+4,y+13);
    c.fillStyle='#fff4';c.fillRect(x+w2-5,y+2,4,A.tH-4)});
  
  // Playhead
  if(S.playing&&S.playhead!==undefined){const px=S.playhead*A.bW;
    c.strokeStyle='#fff';c.lineWidth=2;c.beginPath();c.moveTo(px,0);c.lineTo(px,cv.height);c.stroke()}}

function computeT(pl){const pat=S.patterns.find(p=>p.id===pl.patternId);
  const pk=pat?.key||'C',tk=pl.targetKey||pk;return(pl.transpose||0)+keyShift(pk,tk)}

function initArr(){const cv=$('arrC');let dp=null,doff=0,rp=null,dbp=null,rbp=null;
  function pos(e){const r=cv.getBoundingClientRect();return{x:e.clientX-r.left,y:e.clientY-r.top}}
  function sn(b){return Math.round(b/S.snap)*S.snap}
  
  // Hit test for melodic placements
  function hitP(x,y){const ti=Math.floor(y/A.tH),beat=x/A.bW;
    if(ti<0||ti>=S.tracks.length)return null;
    const tid=S.tracks[ti].id;
    for(let i=S.placements.length-1;i>=0;i--){const pl=S.placements[i];
      if(pl.trackId!==tid)continue;const pat=S.patterns.find(p=>p.id===pl.patternId);if(!pat)continue;
      const tl=pat.length*(pl.repeats||1);
      if(beat>=pl.time&&beat<pl.time+tl)return{pl,i,res:beat>pl.time+tl-.5}}
    return null}
  
  // Hit test for beat placements
  function hitBP(x,y){const ti=Math.floor(y/A.tH)-S.tracks.length,beat=x/A.bW;
    if(ti<0||ti>=S.beatTracks.length)return null;
    const tid=S.beatTracks[ti].id;
    for(let i=S.beatPlacements.length-1;i>=0;i--){const bp=S.beatPlacements[i];
      if(bp.trackId!==tid)continue;const pat=S.beatPatterns.find(p=>p.id===bp.patternId);if(!pat)continue;
      const tl=pat.length*(bp.repeats||1);
      if(beat>=bp.time&&beat<bp.time+tl)return{bp,i,res:beat>bp.time+tl-.5}}
    return null}
  
  cv.addEventListener('dragover',e=>e.preventDefault());
  cv.addEventListener('drop',e=>{e.preventDefault();try{const d=JSON.parse(e.dataTransfer.getData('text/plain'));
    const{x,y}=pos(e),ti=Math.floor(y/A.tH);
    
    if(d.type==='pattern'&&ti>=0&&ti<S.tracks.length){
      const pat=S.patterns.find(p=>p.id===d.pid);
      S.placements.push({id:gid(),trackId:S.tracks[ti].id,patternId:d.pid,time:sn(x/A.bW),
        transpose:0,repeats:1,targetKey:pat?.key||'C',targetScale:pat?.scale||'major'});rArr()}
    else if(d.type==='beatPattern'){
      const bti=ti-S.tracks.length;
      if(bti>=0&&bti<S.beatTracks.length){
        S.beatPlacements.push({id:gid(),trackId:S.beatTracks[bti].id,patternId:d.pid,time:sn(x/A.bW),repeats:1});
        rArr();rBeatPlS()}}
  }catch{}});
  
  cv.addEventListener('mousedown',e=>{const{x,y}=pos(e);
    // Right click - delete
    if(e.button===2){e.preventDefault();
      const h=hitP(x,y);
      if(h){S.placements.splice(h.i,1);S.selPl=null;S.selBeatPl=null;rArr();rPlS();return}
      const hb=hitBP(x,y);
      if(hb){S.beatPlacements.splice(hb.i,1);S.selBeatPl=null;S.selPl=null;rArr();rBeatPlS();return}
      return}
    
    // Left click - select or drag
    const h=hitP(x,y);
    if(h){S.selPl=h.pl.id;S.selBeatPl=null;if(h.res)rp=h.pl;else{dp=h.pl;doff=x/A.bW-h.pl.time}rArr();rPlS();return}
    
    const hb=hitBP(x,y);
    if(hb){S.selBeatPl=hb.bp.id;S.selPl=null;if(hb.res)rbp=hb.bp;else{dbp=hb.bp;doff=x/A.bW-hb.bp.time}rArr();rBeatPlS();return}
    
    S.selPl=null;S.selBeatPl=null;rArr();rPlS();rBeatPlS()});
  
  cv.addEventListener('contextmenu',e=>e.preventDefault());
  cv.addEventListener('mousemove',e=>{const{x,y}=pos(e);
    // Drag melodic placement
    if(dp){dp.time=Math.max(0,sn(x/A.bW-doff));const ti=Math.floor(y/A.tH);
      if(ti>=0&&ti<S.tracks.length)dp.trackId=S.tracks[ti].id;rArr()}
    // Resize melodic placement
    else if(rp){const pat=S.patterns.find(p=>p.id===rp.patternId);
      if(pat){rp.repeats=Math.max(1,Math.round((x/A.bW-rp.time)/pat.length));rArr();rPlS()}}
    // Drag beat placement
    else if(dbp){dbp.time=Math.max(0,sn(x/A.bW-doff));const ti=Math.floor(y/A.tH)-S.tracks.length;
      if(ti>=0&&ti<S.beatTracks.length)dbp.trackId=S.beatTracks[ti].id;rArr()}
    // Resize beat placement
    else if(rbp){const pat=S.beatPatterns.find(p=>p.id===rbp.patternId);
      if(pat){rbp.repeats=Math.max(1,Math.round((x/A.bW-rbp.time)/pat.length));rArr();rBeatPlS()}}});
  
  const up=()=>{dp=null;rp=null;dbp=null;rbp=null};cv.addEventListener('mouseup',up);cv.addEventListener('mouseleave',up)}

// ========== Placement Settings ==========
function rPlS(){const c=$('plSet'),pl=S.placements.find(p=>p.id===S.selPl);
  if(!pl){c.innerHTML='<p style="color:var(--text2);font-size:11px">Click a placement</p>';return}
  const pat=S.patterns.find(p=>p.id===pl.patternId),pk=pat?.key||'C',ps=pat?.scale||'major';
  c.innerHTML=`<div class="sr"><label>Pattern</label><span style="font-size:10px">${pat?pat.name:'?'}</span></div>
<div class="sr"><label>Time</label><input type="number" value="${pl.time}" min="0" step="${S.snap}" onchange="uPl('time',+this.value)"> <span style="font-size:9px;color:var(--text2)">beats</span></div>
<div class="sr"><label>Transpose</label><input type="number" value="${pl.transpose||0}" min="-48" max="48" onchange="uPl('transpose',+this.value)"> <span style="font-size:9px;color:var(--text2)">semi</span></div>
<div class="sr"><label>Target Key</label><select onchange="uPl('targetKey',this.value)">${NN.map(n=>`<option ${(pl.targetKey||pk)===n?'selected':''}>${n}</option>`).join('')}</select>
  <select onchange="uPl('targetScale',this.value)">${Object.keys(SCALES).map(s=>`<option value="${s}" ${(pl.targetScale||ps)===s?'selected':''}>${s}</option>`).join('')}</select></div>
<div class="sr"><label></label><span style="font-size:9px;color:var(--text2)">Base: ${pk} ${ps} ‚Üí total shift: ${computeT(pl)} semi</span></div>
<div class="sr"><label>Repeats</label><input type="number" value="${pl.repeats||1}" min="1" max="128" onchange="uPl('repeats',+this.value)"></div>
<div class="sr"><label></label><button class="btn btn-s" style="font-size:10px" onclick="dPl(${pl.id})">Remove</button></div>`}
function uPl(k,v){const pl=S.placements.find(p=>p.id===S.selPl);if(pl){pl[k]=v;rArr();rPlS()}}
function dPl(id){S.placements=S.placements.filter(p=>p.id!==id);S.selPl=null;rArr();rPlS()}

// Beat Placement Settings
function rBeatPlS(){const c=$('plSet'),bp=S.beatPlacements.find(p=>p.id===S.selBeatPl);
  if(!bp){if(!S.selPl)c.innerHTML='<p style="color:var(--text2);font-size:11px">Click a placement</p>';return}
  const pat=S.beatPatterns.find(p=>p.id===bp.patternId);
  c.innerHTML=`<div class="sr"><label>Pattern</label><span style="font-size:10px;color:var(--accent)">${pat?pat.name:'?'}</span></div>
<div class="sr"><label>Time</label><input type="number" value="${bp.time}" min="0" step="${S.snap}" onchange="uBeatPl('time',+this.value)"> <span style="font-size:9px;color:var(--text2)">beats</span></div>
<div class="sr"><label>Repeats</label><input type="number" value="${bp.repeats||1}" min="1" max="128" onchange="uBeatPl('repeats',+this.value)"></div>
<div class="sr"><label></label><button class="btn btn-s" style="font-size:10px" onclick="dBeatPl(${bp.id})">Remove</button></div>`}
function uBeatPl(k,v){const bp=S.beatPlacements.find(p=>p.id===S.selBeatPl);if(bp){bp[k]=v;rArr();rBeatPlS()}}
function dBeatPl(id){S.beatPlacements=S.beatPlacements.filter(p=>p.id!==id);S.selBeatPl=null;rArr();rBeatPlS()}

// ========== Playback ==========
let playAF=null;
function togglePlay(){if(S.playing)stopPlay();else startPlay()}
function toggleLoop(){S.looping=!S.looping;$('loopBtn').classList.toggle('on',S.looping);$('audioEl').loop=S.looping}
async function startPlay(){const arr=buildArr();
  if(!arr.tracks.some(t=>t.placements.some(p=>p.pattern.notes.length>0)))return;
  $('playBtn').textContent='‚èπ';$('playBtn').classList.add('on');S.playing=true;
  try{const r=await fetch('/api/render',{method:'POST',headers:{'Content-Type':'application/json'},
    body:JSON.stringify({arrangement:arr,sf2_path:S.sf2?.path||null,format:'wav'})});
    if(!r.ok){stopPlay();return}const blob=await r.blob(),url=URL.createObjectURL(blob);
    const au=$('audioEl');au.src=url;au.loop=S.looping;au.play();
    let maxB=0;
    S.placements.forEach(pl=>{const pat=S.patterns.find(p=>p.id===pl.patternId);
      if(pat)maxB=Math.max(maxB,pl.time+pat.length*(pl.repeats||1))});
    S.beatPlacements.forEach(bp=>{const pat=S.beatPatterns.find(p=>p.id===bp.patternId);
      if(pat)maxB=Math.max(maxB,bp.time+pat.length*(bp.repeats||1))});
    const bd=60/S.bpm,td=maxB*bd,t0=performance.now();
    function anim(){if(!S.playing)return;const el=(performance.now()-t0)/1000;
      let t=el;if(S.looping&&td>0)t=t%td;S.playhead=t/bd;rArr();
      if(!S.looping&&el>=td){stopPlay();return}playAF=requestAnimationFrame(anim)}anim();
    au.addEventListener('ended',()=>{if(!S.looping)stopPlay()},{once:true})}
  catch(e){console.error(e);stopPlay()}}
function stopPlay(){S.playing=false;S.playhead=undefined;$('playBtn').textContent='‚ñ∂';$('playBtn').classList.remove('on');
  const au=$('audioEl');au.pause();au.currentTime=0;if(playAF)cancelAnimationFrame(playAF);rArr()}

async function previewPattern(){
  const pat=S.patterns.find(p=>p.id===S.selPat);
  const trk=S.tracks.find(t=>t.id===S.selTrk);
  if(!pat||!trk||pat.notes.length===0)return;
  
  // Build a minimal arrangement with just this pattern
  const arr={
    bpm:S.bpm,
    tsNum:S.tsNum,
    tsDen:S.tsDen,
    tracks:[{
      name:trk.name,
      channel:trk.channel,
      bank:trk.bank,
      program:trk.program,
      volume:trk.volume||100,
      placements:[{
        pattern:{notes:pat.notes,length:pat.length},
        time:0,
        transpose:0,
        repeats:1
      }]
    }]
  };
  
  try{
    const r=await fetch('/api/render',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({arrangement:arr,sf2_path:S.sf2?.path||null,format:'wav'})});
    if(!r.ok)return;
    const blob=await r.blob(),url=URL.createObjectURL(blob);
    const au=$('audioEl');au.src=url;au.loop=false;au.play();
  }catch(e){console.error('Pattern preview failed:',e)}
}

// ========== Export ==========
function buildArr(){
  // Assemble melodic tracks (existing logic)
  const melodicTracks = S.tracks.map(t=>({
    name:t.name,channel:t.channel,bank:t.bank,program:t.program,volume:t.volume||100,
    placements:S.placements.filter(p=>p.trackId===t.id).map(p=>{
      const pat=S.patterns.find(pp=>pp.id===p.patternId);
      return{pattern:pat?{notes:pat.notes,length:pat.length}:{notes:[],length:4},
        time:p.time,transpose:computeT(p),repeats:p.repeats||1}
    })
  }));
  
  // Flatten beat tracks into virtual melodic tracks
  const beatTracks = [];
  // One virtual track per kit instrument that has any notes in any placed pattern
  for (const inst of S.beatKit) {
    const placements = [];
    for (const bp of S.beatPlacements) {
      const bt = S.beatTracks.find(t => t.id === bp.trackId);
      if (!bt) continue;
      const pat = S.beatPatterns.find(p => p.id === bp.patternId);
      if (!pat) continue;
      const grid = pat.grid[inst.id];
      if (!grid || !grid.some(v => v > 0)) continue;

      // Convert grid to notes
      const stepDur = pat.length / grid.length;
      const notes = [];
      for (let i = 0; i < grid.length; i++) {
        if (grid[i] > 0) {
          notes.push({
            pitch: inst.pitch,
            velocity: grid[i],
            start: i * stepDur,
            duration: stepDur * 0.8
          });
        }
      }
      placements.push({
        pattern: { notes, length: pat.length },
        time: bp.time,
        transpose: 0,
        repeats: bp.repeats || 1
      });
    }
    if (placements.length > 0) {
      beatTracks.push({
        name: inst.name,
        channel: inst.channel,
        bank: inst.bank,
        program: inst.program,
        volume: 100,  // could later support per-track volume scaling
        placements
      });
    }
  }

  return {
    bpm: S.bpm, tsNum: S.tsNum, tsDen: S.tsDen,
    tracks: [...melodicTracks, ...beatTracks]
  };
}
async function doExport(fmt){const arr=buildArr();
  const ep=fmt==='midi'?'/api/export_midi':'/api/render';
  const body=fmt==='midi'?arr:{arrangement:arr,sf2_path:S.sf2?.path||null,format:fmt};
  const r=await fetch(ep,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
  if(!r.ok){try{const e=await r.json();alert(e.error||'Error')}catch{alert('Export failed')}return}
  dl(await r.blob(),`arrangement.${fmt==='midi'?'mid':fmt}`)}
function dl(b,n){const u=URL.createObjectURL(b),a=document.createElement('a');a.href=u;a.download=n;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(u)}

// ========== Save/Load ==========
function saveProj(){dl(new Blob([JSON.stringify({v:3,bpm:S.bpm,snap:S.snap,tsNum:S.tsNum,tsDen:S.tsDen,
  patterns:S.patterns,tracks:S.tracks,placements:S.placements,
  beatKit:S.beatKit,beatPatterns:S.beatPatterns,beatTracks:S.beatTracks,beatPlacements:S.beatPlacements,
  sf2Path:S.sf2?.path,nextId:S.nextId},null,2)],
  {type:'application/json'}),'arrangement.json')}
function loadProj(){$('projIn').click()}
async function handleProjLoad(e){const f=e.target.files[0];if(!f)return;
  try{const p=JSON.parse(await f.text());S.bpm=p.bpm||120;S.snap=p.snap||.5;S.tsNum=p.tsNum||4;S.tsDen=p.tsDen||4;
    S.patterns=p.patterns||[];S.tracks=p.tracks||[];S.placements=p.placements||[];
    S.beatKit=p.beatKit||[];S.beatPatterns=p.beatPatterns||[];S.beatTracks=p.beatTracks||[];S.beatPlacements=p.beatPlacements||[];
    S.nextId=p.nextId||1;
    S.selPat=null;S.selTrk=S.tracks[0]?.id||null;S.selPl=null;
    S.selBeatPat=null;S.selBeatTrk=null;S.selBeatPl=null;
    $('bpmIn').value=S.bpm;$('snapSel').value=S.snap;$('tsNum').value=S.tsNum;$('tsDen').value=S.tsDen;
    if(p.sf2Path){try{const r=await fetch('/api/load_sf2',{method:'POST',headers:{'Content-Type':'application/json'},
      body:JSON.stringify({path:p.sf2Path})});const d=await r.json();if(!d.error)S.sf2=d}catch{}}
    renderAll()}catch(err){alert('Error: '+err.message)}e.target.value=''}

// ========== Resize ==========
function initResize(){const h=$('resizeH'),pr=$('prArea');let sy,sh;
  h.addEventListener('mousedown',e=>{sy=e.clientY;sh=pr.offsetHeight;
    const mv=e=>{pr.style.height=Math.max(100,sh+sy-e.clientY)+'px';rPR();rVL();rArr()};
    const up=()=>{document.removeEventListener('mousemove',mv);document.removeEventListener('mouseup',up)};
    document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up)})}

// ========== Beat Kit ==========
let beatKitExpanded={};  // Track which instruments are expanded {instId: true/false}

function addBeatInst(){
  // Default to drums channel, or copy last instrument's channel
  const lastInst=S.beatKit[S.beatKit.length-1];
  const ch=lastInst?lastInst.channel:9;
  
  // Find next available pitch
  // Only auto-increment if last instrument was on channel 10 (drums)
  let pitch=36; // Default starting pitch (kick)
  if(lastInst&&lastInst.channel===9){
    // Auto-increment from last drum instrument
    const used=S.beatKit.map(i=>i.pitch);
    pitch=lastInst.pitch+1;
    while(used.includes(pitch)&&pitch<128)pitch++;
  }
  // Otherwise use default pitch 36 for new melodic instruments
  
  const inst={
    id:gid(),
    name:`Inst ${S.beatKit.length+1}`,
    channel:ch,
    bank:0,
    program:0,
    pitch:pitch,
    velocity:100
  };
  S.beatKit.push(inst);
  
  // Initialize this instrument in all existing beat patterns
  S.beatPatterns.forEach(pat=>{
    if(!pat.grid)pat.grid={};
    pat.grid[inst.id]=new Array(pat.length*pat.subdivision).fill(0);
  });
  
  rBK();
  // If a beat pattern is currently selected, refresh the grid to show the new instrument
  if(S.selBeatPat){
    rBG();
  }
}

function delBeatInst(id){
  if(!confirm('Delete this instrument?\nIt will be removed from all beat patterns.'))return;
  S.beatKit=S.beatKit.filter(i=>i.id!==id);
  // Clean up pattern grids
  S.beatPatterns.forEach(pat=>{
    if(pat.grid)delete pat.grid[id];
  });
  delete beatKitExpanded[id];
  rBK();
}

function toggleBeatInst(id){
  beatKitExpanded[id]=!beatKitExpanded[id];
  rBK();
}

function uBeatInst(id,k,v){
  const inst=S.beatKit.find(i=>i.id===id);
  if(inst){
    inst[k]=v;
    rBK();
  }
}

async function previewBeatInst(id){
  const inst=S.beatKit.find(i=>i.id===id);
  if(!inst)return;
  
  const isDrums=inst.channel===9;
  
  // Try SF2 first
  if(S.sf2?.path){
    try{
      // For drums (channel 10), use bank 128 program 0, and pitch determines the drum sound
      // For melodic instruments, use the instrument's bank/program and pitch
      const bank=isDrums?128:inst.bank;
      const program=isDrums?0:inst.program;
      const pitch=inst.pitch; // Use actual pitch for both drums and melodic
      
      const r=await fetch('/api/render_sample',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          sf2_path:S.sf2.path,
          bank:bank,
          program:program,
          pitch:pitch,
          velocity:inst.velocity,
          duration:0.3,
          channel:inst.channel  // Pass channel so backend can use correct MIDI channel
        })
      });
      if(r.ok){
        const arrayBuf=await r.arrayBuffer();
        const ctx=getAudioCtx();
        const audioBuf=await ctx.decodeAudioData(arrayBuf);
        const src=ctx.createBufferSource();
        src.buffer=audioBuf;
        src.connect(ctx.destination);
        src.start();
        return;
      }
    }catch(e){console.warn('SF2 preview failed:',e)}
  }
  
  // Fallback to sine
  playSine(inst.pitch,inst.velocity,0.15);
}

function rBK(){
  const c=$('beatKit');
  if(S.beatKit.length===0){
    c.innerHTML='<p style="color:var(--text2);font-size:10px;margin-top:4px">No instruments. Click + to add.</p>';
    return;
  }
  
  // Get available banks from SF2
  const banks=S.sf2?.presets?[...new Set(S.sf2.presets.map(p=>p.bank))].sort((a,b)=>a-b):[];
  
  c.innerHTML=S.beatKit.map((inst,idx)=>{
    const exp=beatKitExpanded[inst.id];
    const color=PC[idx%PC.length];
    const isDrums=inst.channel===9;
    
    // Get presets for this instrument's bank
    const presets=S.sf2?.presets?S.sf2.presets.filter(p=>p.bank===inst.bank):[];
    
    return `<div class="bki ${exp?'exp':''}">
      <div class="bki-h" onclick="toggleBeatInst(${inst.id})" style="cursor:pointer">
        <div class="cd" style="background:${color}"></div>
        <div class="nm">${inst.name}</div>
        <button onclick="event.stopPropagation();previewBeatInst(${inst.id})" title="Preview">‚ñ∂</button>
        <button onclick="event.stopPropagation();delBeatInst(${inst.id})" title="Delete">‚úï</button>
      </div>
      <div class="bki-e">
        <div class="bki-r">
          <label>Name</label>
          <input type="text" value="${inst.name}" onclick="event.stopPropagation()" onchange="uBeatInst(${inst.id},'name',this.value)">
        </div>
        <div class="bki-r">
          <label>Channel</label>
          <select onclick="event.stopPropagation()" onchange="uBeatInst(${inst.id},'channel',+this.value);rBK()">
            ${Array.from({length:16},(_,i)=>`<option value="${i}" ${inst.channel===i?'selected':''}>Ch ${i+1}${i===9?' (Drums)':''}</option>`).join('')}
          </select>
        </div>
        ${S.sf2?.presets?`
        <div class="bki-r">
          <label>Bank</label>
          <select onclick="event.stopPropagation()" onchange="uBeatInst(${inst.id},'bank',+this.value)" ${isDrums?'disabled style="opacity:0.5"':''}>
            ${banks.map(b=>`<option value="${b}" ${inst.bank===b?'selected':''}>Bank ${b}</option>`).join('')}
          </select>
        </div>
        <div class="bki-r">
          <label>Preset</label>
          <select onclick="event.stopPropagation()" onchange="uBeatInst(${inst.id},'program',+this.value)" style="flex:1" ${isDrums?'disabled style="opacity:0.5"':''}>
            ${isDrums?'<option>(Drum Kit)</option>':presets.map(p=>`<option value="${p.program}" ${inst.program===p.program?'selected':''}>${p.program}: ${p.name}</option>`).join('')}
          </select>
        </div>
        `:`
        <div class="bki-r">
          <label>Bank</label>
          <input type="number" value="${inst.bank}" min="0" max="16383" onclick="event.stopPropagation()" onchange="uBeatInst(${inst.id},'bank',+this.value)" ${isDrums?'disabled style="opacity:0.5"':''}>
        </div>
        <div class="bki-r">
          <label>Program</label>
          <input type="number" value="${inst.program}" min="0" max="127" onclick="event.stopPropagation()" onchange="uBeatInst(${inst.id},'program',+this.value)" ${isDrums?'disabled style="opacity:0.5"':''}>
        </div>
        <div class="bki-r">
          <label>Preset</label>
          <span style="font-size:9px;color:${isDrums?'var(--text2)':'var(--accent)'}">${isDrums?'(Drum Kit)':pName(inst.bank,inst.program)}</span>
        </div>
        `}
        <div class="bki-r">
          <label>Pitch</label>
          <input type="number" value="${inst.pitch}" min="0" max="127" onclick="event.stopPropagation()" onchange="uBeatInst(${inst.id},'pitch',+this.value)">
          <span style="font-size:9px;color:var(--text2);margin-left:2px">${NN[inst.pitch%12]}${Math.floor(inst.pitch/12)-1}</span>
        </div>
        <div class="bki-r">
          <label>Velocity</label>
          <input type="range" min="1" max="127" value="${inst.velocity}" onclick="event.stopPropagation()" oninput="uBeatInst(${inst.id},'velocity',+this.value)">
          <span style="font-size:9px;width:22px">${inst.velocity}</span>
        </div>
      </div>
    </div>`;
  }).join('');
}

// ========== Beat Patterns ==========
function createBeatPat(){
  $('bpmT').textContent='New Beat Pattern';
  $('bpmName').value='Beat '+(S.beatPatterns.length+1);
  $('bpmLen').value=S.tsNum;
  $('bpmSubdiv').value='4';
  $('beatPatModal').classList.add('show');
  $('beatPatModal').dataset.m='c';
  $('bpmName').focus();
}

function submitBeatPat(){
  const m=$('beatPatModal').dataset.m;
  const nm=$('bpmName').value||'Beat';
  const len=Math.max(1,+$('bpmLen').value||4);
  const subdiv=+$('bpmSubdiv').value||4;
  
  if(m==='c'){
    // Create new pattern
    const p={
      id:gid(),
      name:nm,
      length:len,
      subdivision:subdiv,
      color:PC[S.beatPatterns.length%PC.length],
      grid:{}  // {instrumentId: [vel, vel, ...]} - initialized empty
    };
    // Initialize grid for all existing instruments
    S.beatKit.forEach(inst=>{
      p.grid[inst.id]=new Array(len*subdiv).fill(0);
    });
    S.beatPatterns.push(p);
    S.selBeatPat=p.id;
    S.selPat=null;  // Deselect melodic pattern
  }else{
    // Edit existing pattern
    const p=S.beatPatterns.find(x=>x.id===S.selBeatPat);
    if(p){
      const oldLen=p.length*p.subdivision;
      const newLen=len*subdiv;
      p.name=nm;
      p.length=len;
      p.subdivision=subdiv;
      // Resize grids if length/subdiv changed
      if(oldLen!==newLen){
        S.beatKit.forEach(inst=>{
          const old=p.grid[inst.id]||[];
          const newGrid=new Array(newLen).fill(0);
          // Copy what fits
          for(let i=0;i<Math.min(old.length,newLen);i++){
            newGrid[i]=old[i];
          }
          p.grid[inst.id]=newGrid;
        });
      }
    }
  }
  $('beatPatModal').classList.remove('show');
  renderAll();
}

function selectBeatPat(id){
  S.selBeatPat=id;
  S.selPat=null;  // Deselect melodic pattern when selecting beat pattern
  rBeatPatList();
  rPatList();
  rBG();
}

function renameBeatPat(id){
  const p=S.beatPatterns.find(x=>x.id===id);
  if(!p)return;
  S.selBeatPat=id;
  $('bpmT').textContent='Edit Beat Pattern';
  $('bpmName').value=p.name;
  $('bpmLen').value=p.length;
  $('bpmSubdiv').value=p.subdivision;
  $('beatPatModal').classList.add('show');
  $('beatPatModal').dataset.m='e';
}

function delBeatPat(id){
  if(!confirm('Delete this beat pattern?'))return;
  S.beatPatterns=S.beatPatterns.filter(x=>x.id!==id);
  S.beatPlacements=S.beatPlacements.filter(x=>x.patternId!==id);
  if(S.selBeatPat===id)S.selBeatPat=null;
  renderAll();
}

function dupBeatPat(id){
  const p=S.beatPatterns.find(x=>x.id===id);
  if(!p)return;
  const n={...JSON.parse(JSON.stringify(p)),id:gid(),name:p.name+' copy',color:PC[S.beatPatterns.length%PC.length]};
  S.beatPatterns.push(n);
  S.selBeatPat=n.id;
  S.selPat=null;
  renderAll();
}

function rBeatPatList(){
  const c=$('beatPatList');
  if(S.beatPatterns.length===0){
    c.innerHTML='<div style="padding:8px;color:var(--text2);font-size:10px;text-align:center">No beat patterns</div>';
    return;
  }
  c.innerHTML='';
  S.beatPatterns.forEach(p=>{
    const d=document.createElement('div');
    d.className='pi'+(S.selBeatPat===p.id?' sel':'');
    d.innerHTML=`<span class="cd" style="background:${p.color}"></span><span class="nm">${p.name} <span style="color:var(--text2);font-size:9px">${p.length}b √∑${p.subdivision}</span></span><span class="ac"><button title="Dup" onclick="event.stopPropagation();dupBeatPat(${p.id})">‚ßâ</button><button title="Edit" onclick="event.stopPropagation();renameBeatPat(${p.id})">‚úé</button><button title="Del" onclick="event.stopPropagation();delBeatPat(${p.id})">‚úï</button></span>`;
    d.onclick=()=>selectBeatPat(p.id);
    d.draggable=true;
    d.ondragstart=e=>e.dataTransfer.setData('text/plain',JSON.stringify({type:'beatPattern',pid:p.id}));
    c.appendChild(d);
  });
}

// ========== Beat Grid Editor ==========
const BG={rH:28,cW:24,minCW:16,maxCW:48};  // row height, cell width

function buildBeatLanes(){
  const c=$('beatLanes');
  c.innerHTML='';
  S.beatKit.forEach((inst,idx)=>{
    const d=document.createElement('div');
    d.className='bgl-i';
    d.innerHTML=`<span class="cd" style="background:${PC[idx%PC.length]}"></span><span class="nm">${inst.name}</span>`;
    d.style.height=BG.rH+'px';
    d.onclick=()=>playBeatHit(inst.id);
    c.appendChild(d);
  });
}

function rBG(){
  const pat=S.beatPatterns.find(x=>x.id===S.selBeatPat);
  
  // Update header
  $('prName').textContent=pat?`‚úé ${pat.name} (${pat.length}b √∑${pat.subdivision})`:'No beat pattern';
  
  // Show/hide appropriate content
  $('prContent').style.display=pat?'none':'flex';
  $('bgContent').style.display=pat?'flex':'none';
  
  // Update preview button handler
  const prevBtn=$('prevBtn');
  prevBtn.onclick=pat?previewBeatPattern:previewPattern;
  
  if(!pat)return;
  
  buildBeatLanes();
  
  const cv=$('bgC'),w=$('bgWrap');
  const numRows=S.beatKit.length;
  const numCols=pat.length*pat.subdivision;
  const tW=numCols*BG.cW;
  const tH=numRows*BG.rH;
  
  cv.width=Math.max(tW,w.clientWidth||600);
  cv.height=Math.max(tH,w.clientHeight-2||200);
  
  const c=cv.getContext('2d');
  c.clearRect(0,0,cv.width,cv.height);
  
  // Background rows
  S.beatKit.forEach((inst,row)=>{
    const y=row*BG.rH;
    c.fillStyle=row%2?'#181828':'#1a1a30';
    c.fillRect(0,y,cv.width,BG.rH);
    c.strokeStyle='#222244';
    c.lineWidth=.5;
    c.beginPath();
    c.moveTo(0,y+BG.rH);
    c.lineTo(cv.width,y+BG.rH);
    c.stroke();
  });
  
  // Grid columns (beat divisions and subdivisions)
  const beatsPerMeasure=S.tsNum*(4/S.tsDen);
  for(let col=0;col<=numCols;col++){
    const x=col*BG.cW;
    const beatNum=col/pat.subdivision;
    const isMeasure=Math.abs(beatNum%beatsPerMeasure)<0.001||beatNum===0;
    const isBeat=col%pat.subdivision===0;
    
    c.strokeStyle=isMeasure?'#4a4a8a':isBeat?'#3a3a6a':'#2a2a4a';
    c.lineWidth=isMeasure?1.5:isBeat?1:.5;
    c.beginPath();
    c.moveTo(x,0);
    c.lineTo(x,cv.height);
    c.stroke();
  }
  
  // Draw notes (cells with velocity)
  S.beatKit.forEach((inst,row)=>{
    const grid=pat.grid[inst.id];
    if(!grid)return;
    
    const y=row*BG.rH;
    const color=PC[row%PC.length];
    
    grid.forEach((vel,col)=>{
      if(vel>0){
        const x=col*BG.cW;
        c.fillStyle=velColor(vel);
        c.globalAlpha=0.85;
        c.fillRect(x+1,y+2,BG.cW-2,BG.rH-4);
        c.globalAlpha=1;
        c.strokeStyle=color;
        c.lineWidth=1;
        c.strokeRect(x+1,y+2,BG.cW-2,BG.rH-4);
        
        // Show velocity value if cell is wide enough
        if(BG.cW>=20&&vel>=10){
          c.fillStyle='#fff';
          c.font='8px sans-serif';
          c.fillText(vel,x+4,y+BG.rH-6);
        }
      }
    });
  });
}

function initBG(){
  const cv=$('bgC');
  
  function pos(e){
    const r=cv.getBoundingClientRect();
    return{x:e.clientX-r.left,y:e.clientY-r.top};
  }
  
  function getCell(x,y){
    const row=Math.floor(y/BG.rH);
    const col=Math.floor(x/BG.cW);
    return{row,col};
  }
  
  cv.addEventListener('mousedown',e=>{
    const pat=S.beatPatterns.find(x=>x.id===S.selBeatPat);
    if(!pat||S.beatKit.length===0)return;
    
    const{x,y}=pos(e);
    const{row,col}=getCell(x,y);
    
    if(row<0||row>=S.beatKit.length)return;
    if(col<0||col>=pat.length*pat.subdivision)return;
    
    const inst=S.beatKit[row];
    if(!inst)return;
    
    const grid=pat.grid[inst.id];
    if(!grid)return;
    
    // Right click - clear cell
    if(e.button===2){
      e.preventDefault();
      grid[col]=0;
      rBG();
      return;
    }
    
    // Left click - toggle or set velocity
    const vel=+$('velSlider').value||100;
    if(grid[col]>0){
      // Already has a note - clear it
      grid[col]=0;
    }else{
      // Place note
      grid[col]=vel;
      playBeatHit(inst.id);
    }
    rBG();
  });
  
  cv.addEventListener('contextmenu',e=>e.preventDefault());
  
  // Sync scroll with beat lanes
  let scrolling=false;
  $('bgWrap').addEventListener('scroll',()=>{
    if(scrolling)return;
    scrolling=true;
    $('beatLanes').scrollTop=$('bgWrap').scrollTop;
    requestAnimationFrame(()=>scrolling=false);
  });
  $('beatLanes').addEventListener('scroll',()=>{
    if(scrolling)return;
    scrolling=true;
    $('bgWrap').scrollTop=$('beatLanes').scrollTop;
    requestAnimationFrame(()=>scrolling=false);
  });
}

async function playBeatHit(instId){
  const inst=S.beatKit.find(i=>i.id===instId);
  if(!inst)return;
  
  const isDrums=inst.channel===9;
  
  // Use SF2 if available, otherwise sine fallback
  if(S.sf2?.path){
    if(isDrums){
      // For drums, we need to render the actual drum sample at its pitch
      // Can't use cached pitch-shifting because each drum pitch is a different instrument
      try{
        const r=await fetch('/api/render_sample',{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify({
            sf2_path:S.sf2.path,
            bank:128,
            program:0,
            pitch:inst.pitch,
            velocity:inst.velocity||100,
            duration:0.2,
            channel:9  // Drum channel
          })
        });
        if(r.ok){
          const arrayBuf=await r.arrayBuffer();
          const ctx=getAudioCtx();
          const audioBuf=await ctx.decodeAudioData(arrayBuf);
          const src=ctx.createBufferSource();
          src.buffer=audioBuf;
          src.connect(ctx.destination);
          src.start();
          return;
        }
      }catch(e){
        console.warn('Drum preview failed:',e);
      }
    }else{
      // For melodic instruments, use the cached pitch-shifting approach
      await playNoteSF2(inst.pitch,inst.velocity||100,inst.bank||0,inst.program||0);
      return;
    }
  }
  
  // Fallback to sine
  playSine(inst.pitch,inst.velocity||100,0.1);
}


async function previewBeatPattern(){
  const pat=S.beatPatterns.find(x=>x.id===S.selBeatPat);
  if(!pat||S.beatKit.length===0)return;
  
  // Build a mini arrangement with one virtual track per instrument
  const tracks=[];
  S.beatKit.forEach(inst=>{
    const grid=pat.grid[inst.id];
    if(!grid||!grid.some(v=>v>0))return;
    
    // Convert grid to notes
    const stepDur=pat.length/grid.length;
    const notes=[];
    for(let i=0;i<grid.length;i++){
      if(grid[i]>0){
        notes.push({
          pitch:inst.pitch,
          velocity:grid[i],
          start:i*stepDur,
          duration:stepDur*0.8
        });
      }
    }
    
    tracks.push({
      name:inst.name,
      channel:inst.channel||10,
      bank:inst.bank||0,
      program:inst.program||0,
      volume:100,
      placements:[{
        pattern:{notes,length:pat.length},
        time:0,
        transpose:0,
        repeats:1
      }]
    });
  });
  
  if(tracks.length===0){
    alert('No notes in this beat pattern');
    return;
  }
  
  const arr={bpm:S.bpm,tsNum:S.tsNum,tsDen:S.tsDen,tracks};
  
  try{
    const r=await fetch('/api/render',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({arrangement:arr,sf2_path:S.sf2?.path||null,format:'wav'})
    });
    if(!r.ok)return;
    const blob=await r.blob(),url=URL.createObjectURL(blob);
    const au=$('audioEl');au.src=url;au.loop=false;au.play();
  }catch(e){
    console.error('Beat pattern preview failed:',e);
  }
}

// ========== Init ==========
function renderAll(){rPatList();rPKI();rTL();rTS();rPR();rVL();rArr();rPlS();rBK();rBeatPatList();rBG()}

window.addEventListener('load',async()=>{buildKeys();initPR();initBG();initArr();initResize();
  await autoLoadFirstSF2();
  S.patterns.push({id:gid(),name:'Pattern 1',length:4,notes:[],color:PC[0],key:'C',scale:'major',previewMode:'sf2'});
  S.selPat=S.patterns[0].id;addTrack();renderAll();
  window.addEventListener('resize',()=>{rPR();rVL();rBG();rArr()})});
</script>
</body></html>
